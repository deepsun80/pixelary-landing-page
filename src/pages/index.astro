---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Scene1Hero from '../components/Scene1Hero.astro';
import Scene2Services from '../components/Scene2Services.astro';
import Scene3Contact from '../components/Scene3Contact.astro';
import Footer from '../components/Footer.astro';
---

<BaseLayout>
  <Header />
  <Scene1Hero />
  <Scene2Services />
  <Scene3Contact />
  <Footer />
</BaseLayout>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // ===== SCENE 1: Hero Animation =====

  // Set initial states
  gsap.set('#header', { opacity: 0, y: -70 });
  gsap.set('#header-logo', { opacity: 0 });

  // Phase 1: Pinned animation (logo shrinks and moves left)
  const scene1Tl = gsap.timeline({
    scrollTrigger: {
      trigger: '#scene-1',
      start: 'top top',
      end: '+=400',
      pin: true,
      scrub: true,
    },
  });

  // Fade out tagline (0% - 30%)
  scene1Tl.to('#hero-tagline', {
    opacity: 0,
    y: -20,
    duration: 0.3,
  });

  // Fade out scroll indicator at same time (0% - 25%)
  scene1Tl.to(
    '#scroll-indicator',
    {
      opacity: 0,
      duration: 0.25,
    },
    0,
  );

  // Calculate the x offset dynamically
  const calculateLogoOffset = () => {
    const heroLogo = document.getElementById('hero-logo');
    const headerLogo = document.getElementById('header-logo');
    const header = document.getElementById('header');

    // Temporarily make header visible for measurement
    const originalOpacity = header.style.opacity;
    const originalTransform = header.style.transform;
    header.style.opacity = '1';
    header.style.transform = 'translateY(0)';

    const heroRect = heroLogo.getBoundingClientRect();
    const headerRect = headerLogo.getBoundingClientRect();

    // Restore header styles
    header.style.opacity = originalOpacity;
    header.style.transform = originalTransform;

    // Current center of hero logo
    const heroCenterX = heroRect.left + heroRect.width / 2;

    // Target center (where header logo center is)
    const headerCenterX = headerRect.left + headerRect.width / 2;

    // The distance we need to move
    const deltaX = headerCenterX - heroCenterX;

    return deltaX;
  };

  const logoOffsetX = calculateLogoOffset();

  // Shrink and move hero logo left only (10% - 70%)
  const isMobile = window.innerWidth <= 768;

  scene1Tl.to(
    '#hero-logo',
    {
      scale: isMobile ? 0.4 : 0.2,
      x: logoOffsetX,
      duration: 0.6,
    },
    0.1,
  );

  // Hold at end (70% - 100%)
  scene1Tl.to({}, { duration: 0.3 });

  // Phase 2: After pin releases - header and logo crossfade
  // This triggers when scene-1 starts scrolling up (after pin ends)

  // Header slides in as scene scrolls away
  gsap.to('#header', {
    opacity: 1,
    y: 0,
    ease: 'none',
    scrollTrigger: {
      trigger: '#scene-1',
      start: 'bottom 90%', // When bottom of scene-1 is at 90% of viewport
      end: 'bottom 60%', // When bottom of scene-1 is at 60% of viewport
      scrub: true,
    },
  });

  // Header logo fades in (slightly after hero logo starts fading)
  gsap.to('#header-logo', {
    opacity: 1,
    ease: 'none',
    scrollTrigger: {
      trigger: '#scene-1',
      start: 'bottom 60%',
      end: 'bottom 30%',
      scrub: true,
    },
  });

  // ===== SCENE 2: Services Animation =====

  // Set initial states
  gsap.set('#diamond-single', { opacity: 0 });
  gsap.set('#diamonds-container', { opacity: 0 });
  gsap.set('#diamond-1', { x: 300 });
  gsap.set('#diamond-3', { x: -300 });
  gsap.set('#diamond-content-1', { opacity: 0 });
  gsap.set('#diamond-content-2', { opacity: 0 });
  gsap.set('#diamond-content-3', { opacity: 0 });

  // Create timeline for Scene 2
  const scene2Tl = gsap.timeline({
    scrollTrigger: {
      trigger: '#scene-2',
      start: 'top top',
      end: '+=1000',
      pin: true,
      scrub: true,
    },
  });

  // Step 1: Single diamond fades in (0% - 15% of timeline)
  scene2Tl.to('#diamond-single', {
    opacity: 1,
    duration: 0.15,
  });

  // Pause - diamond sits visible (15% - 25%)
  scene2Tl.to({}, { duration: 0.1 });

  // Step 2: Single diamond fades out, three diamonds fade in (25% - 35%)
  scene2Tl.to('#diamond-single', {
    opacity: 0,
    duration: 0.1,
  });

  scene2Tl.to(
    '#diamonds-container',
    {
      opacity: 1,
      duration: 0.1,
    },
    '<',
  ); // Same time as above

  // Step 3: Diamonds spread horizontally (35% - 60%)
  scene2Tl.to(
    '#diamond-1',
    {
      x: 0,
      duration: 0.25,
    },
    '<',
  );

  scene2Tl.to(
    '#diamond-3',
    {
      x: 0,
      duration: 0.25,
    },
    '<',
  );

  // Step 4: Content fades in (50% - 70%)
  scene2Tl.to(
    ['#diamond-content-1', '#diamond-content-2', '#diamond-content-3'],
    {
      opacity: 1,
      duration: 0.2,
    },
    '-=0.1',
  ); // Slightly overlapping with spread

  // Hold at end (70% - 100%) - diamonds stay visible
  scene2Tl.to({}, { duration: 0.3 });

  // ===== SCENE 3: Contact Animation =====

  // Set initial states
  gsap.set('#sphere', { x: 300 });
  gsap.set('#contact-form-wrapper', { opacity: 0 });
  gsap.set('#contact-text', { opacity: 0 });

  // Create timeline for Scene 3
  const scene3Tl = gsap.timeline({
    scrollTrigger: {
      trigger: '#scene-3',
      start: 'top top',
      end: '+=800',
      pin: true,
      scrub: true,
    },
  });

  // Step 1: Sphere rolls in from right (0% - 30%)
  scene3Tl.to('#sphere', {
    x: 0,
    duration: 0.3,
    ease: 'none',
  });

  // Step 2: Contact form fades in (25% - 50%)
  scene3Tl.to(
    '#contact-form-wrapper',
    {
      opacity: 1,
      duration: 0.25,
    },
    '-=0.05',
  );

  // Step 3: Text fades in (40% - 65%)
  scene3Tl.to(
    '#contact-text',
    {
      opacity: 1,
      duration: 0.25,
    },
    '-=0.1',
  );

  // Hold at end (65% - 100%) - everything stays visible
  scene3Tl.to({}, { duration: 0.35 });
</script>
